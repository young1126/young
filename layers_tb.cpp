// tb_mnist_cnn.cpp
#include <iostream>
#include <hls_stream.h>
#include "layers.h"

#define BATCH_SIZE 1
// --------------------------------------------------------
// Python에서 생성한 이진화 MNIST 이미지 10장(0~255 그레이스케일 → 0/1 thresholded)과 레이블
static const uint8_t test_imgs[10][784] = {
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,84,185,159,151,60,36,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,222,254,254,254,254,241,198,198,198,198,
     198,198,198,198,170,52,0,0,0,0,0,0,0,0,0,0,0,0,67,114,
     72,114,163,227,254,225,254,254,254,250,229,254,254,140,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,17,66,14,67,67,67,59,21,236,
     254,106,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,83,253,209,18,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,22,233,255,83,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,129,254,238,44,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,59,249,254,62,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,133,254,187,5,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,9,205,248,58,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,126,254,182,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,75,251,
     240,57,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,19,221,254,166,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,3,203,254,219,35,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     38,254,254,77,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,31,224,254,115,1,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,133,254,254,52,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,61,242,254,254,52,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,121,254,254,219,40,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,121,254,
     207,18,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,116,125,171,255,255,150,
     93,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,169,253,253,253,253,253,253,218,30,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,169,253,253,253,213,142,176,253,253,122,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,52,250,253,210,32,
     12,0,6,206,253,140,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,77,251,210,25,0,0,0,122,248,253,65,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,31,18,0,0,0,0,209,253,
     253,65,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,117,247,253,198,10,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,76,247,253,231,63,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     128,253,253,144,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,176,246,253,159,12,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,25,234,253,233,35,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,198,253,253,141,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,78,248,253,189,12,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,19,200,253,253,
     141,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,134,253,253,173,12,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,248,253,253,25,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     248,253,253,43,20,20,20,20,5,0,5,20,20,37,150,150,150,147,10,0,
     0,0,0,0,0,0,0,0,248,253,253,253,253,253,253,253,168,143,166,253,
     253,253,253,253,253,253,123,0,0,0,0,0,0,0,0,0,174,253,253,253,
     253,253,253,253,253,253,253,253,249,247,247,169,117,117,57,0,0,0,0,0,
     0,0,0,0,0,118,123,123,123,166,253,253,253,155,123,123,41,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,38,254,109,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,87,252,82,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,135,241,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,45,244,150,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,84,
     254,63,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,202,223,11,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,32,254,216,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,95,254,195,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,140,254,77,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,57,237,205,
     8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,124,255,165,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,171,254,81,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     24,232,215,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,120,254,159,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,151,254,142,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,228,254,66,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,61,251,254,66,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,141,
     254,205,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,10,215,254,121,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,198,176,10,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,11,150,253,202,31,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,37,251,251,253,107,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,21,
     197,251,251,253,107,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,110,190,251,251,251,253,169,109,62,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,253,251,251,251,251,253,
     251,251,220,51,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,182,255,253,253,253,253,234,222,253,253,253,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,63,221,253,251,251,251,147,77,62,128,251,251,
     105,0,0,0,0,0,0,0,0,0,0,0,0,0,0,32,231,251,253,251,
     220,137,10,0,0,31,230,251,243,113,5,0,0,0,0,0,0,0,0,0,
     0,0,0,37,251,251,253,188,20,0,0,0,0,0,109,251,253,251,35,0,
     0,0,0,0,0,0,0,0,0,0,0,37,251,251,201,30,0,0,0,0,
     0,0,31,200,253,251,35,0,0,0,0,0,0,0,0,0,0,0,0,37,
     253,253,0,0,0,0,0,0,0,0,32,202,255,253,164,0,0,0,0,0,
     0,0,0,0,0,0,0,140,251,251,0,0,0,0,0,0,0,0,109,251,
     253,251,35,0,0,0,0,0,0,0,0,0,0,0,0,217,251,251,0,0,
     0,0,0,0,21,63,231,251,253,230,30,0,0,0,0,0,0,0,0,0,
     0,0,0,217,251,251,0,0,0,0,0,0,144,251,251,251,221,61,0,0,
     0,0,0,0,0,0,0,0,0,0,0,217,251,251,0,0,0,0,0,182,
     221,251,251,251,180,0,0,0,0,0,0,0,0,0,0,0,0,0,0,218,
     253,253,73,73,228,253,253,255,253,253,253,253,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,113,251,251,253,251,251,251,251,253,251,251,251,147,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,31,230,251,253,251,
     251,251,251,253,230,189,35,10,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,62,142,253,251,251,251,251,253,107,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,72,174,251,173,71,72,
     30,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,50,224,0,0,0,0,0,0,0,70,
     29,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,121,231,
     0,0,0,0,0,0,0,148,168,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,4,195,231,0,0,0,0,0,0,0,96,210,11,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,69,252,134,0,0,0,0,
     0,0,0,114,252,21,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     45,236,217,12,0,0,0,0,0,0,0,192,252,21,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,168,247,53,0,0,0,0,0,0,0,18,255,
     253,21,0,0,0,0,0,0,0,0,0,0,0,0,0,84,242,211,0,0,
     0,0,0,0,0,0,141,253,189,5,0,0,0,0,0,0,0,0,0,0,
     0,0,0,169,252,106,0,0,0,0,0,0,0,32,232,250,66,0,0,0,
     0,0,0,0,0,0,0,0,0,0,15,225,252,0,0,0,0,0,0,0,
     0,134,252,211,0,0,0,0,0,0,0,0,0,0,0,0,0,0,22,252,
     164,0,0,0,0,0,0,0,0,169,252,167,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,9,204,209,18,0,0,0,0,0,0,22,253,253,107,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,169,252,199,85,85,
     85,85,129,164,195,252,252,106,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,41,170,245,252,252,252,252,232,231,251,252,252,9,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,49,84,84,84,84,0,0,
     161,252,252,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,127,252,252,45,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,253,253,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,127,252,252,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,135,252,244,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     232,236,111,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,179,66,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,77,254,107,3,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,19,227,254,254,9,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,81,254,254,165,1,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,203,
     254,254,73,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,53,254,254,250,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,134,254,254,180,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,196,254,248,48,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,58,254,254,237,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,111,254,254,
     132,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,163,254,238,28,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,60,252,254,223,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     79,254,254,154,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,163,254,238,53,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,28,252,254,210,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,86,254,254,131,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,105,254,234,20,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,175,
     254,204,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,5,211,254,196,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,158,254,160,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,26,157,107,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,22,192,134,32,0,0,0,0,0,0,0,
     0,15,77,5,0,0,0,0,0,0,0,0,0,0,0,0,17,235,250,169,
     0,0,0,0,0,0,0,0,15,220,241,37,0,0,0,0,0,0,0,0,
     0,0,0,20,189,253,147,0,0,0,0,0,0,0,0,0,139,253,100,0,
     0,0,0,0,0,0,0,0,0,0,0,70,253,253,21,0,0,0,0,0,
     0,0,0,43,254,173,13,0,0,0,0,0,0,0,0,0,0,0,22,153,
     253,96,0,0,0,0,0,0,0,0,43,231,254,92,0,0,0,0,0,0,
     0,0,0,0,0,0,163,255,204,11,0,0,0,0,0,0,0,0,104,254,
     158,0,0,0,0,0,0,0,0,0,0,0,0,0,162,253,178,5,0,0,
     0,0,0,0,9,131,237,253,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,162,253,253,191,175,70,70,70,70,133,197,253,253,169,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,51,228,253,253,254,253,253,253,253,254,
     253,253,219,35,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,17,
     65,137,254,232,137,137,137,44,253,253,161,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,34,254,206,21,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,160,253,69,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,85,254,241,50,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,158,254,
     165,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,231,244,50,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,104,254,232,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,208,253,157,0,13,30,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,208,253,154,91,204,161,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,208,253,254,
     253,154,29,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,61,190,128,23,6,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,14,
     149,193,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,91,224,253,253,19,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,28,235,254,253,253,166,18,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,144,253,254,253,253,253,238,115,6,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,31,241,253,208,185,253,253,253,231,24,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,79,254,193,0,
     8,98,219,254,255,201,18,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,86,253,80,0,0,0,182,253,254,191,12,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,175,253,155,0,0,0,234,253,
     254,135,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     86,253,208,40,85,166,251,237,254,236,42,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,18,238,253,254,253,253,185,36,216,253,152,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,68,240,255,
     254,145,8,0,134,254,223,35,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,68,158,142,12,0,0,9,175,253,161,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,88,253,226,18,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,2,166,253,126,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,48,245,
     253,38,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,115,254,172,9,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,21,218,254,46,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,30,254,165,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,186,244,42,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,14,223,78,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,17,47,47,47,16,129,85,47,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,75,153,217,253,253,
     253,215,246,253,253,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     35,142,244,252,253,253,253,253,253,253,253,253,253,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,63,253,253,253,253,253,253,253,213,170,170,170,
     170,0,0,0,0,0,0,0,0,0,0,0,20,132,72,0,57,238,227,238,
     168,124,69,20,11,0,0,0,0,0,0,0,0,0,0,0,0,0,0,11,
     206,253,78,0,0,32,0,30,2,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,6,177,253,132,10,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,12,133,253,233,15,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,92,253,223,28,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,150,253,174,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,234,253,246,
     127,49,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,255,253,253,253,251,147,91,121,85,42,42,85,28,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,139,253,253,253,253,253,253,
     253,253,253,253,253,232,168,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,3,53,218,222,251,253,253,253,253,253,253,253,253,252,124,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,67,72,200,253,253,253,253,
     253,253,253,175,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,120,253,249,152,51,164,253,253,175,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,50,253,253,253,188,252,253,253,148,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,9,
     167,253,253,253,253,250,175,11,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,23,180,231,253,221,128,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,93,149,
     22,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0},
    {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,36,56,137,201,199,95,37,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,45,152,234,254,254,
     254,254,254,250,211,151,6,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,46,153,240,254,254,227,166,133,251,200,254,229,225,104,0,0,0,0,0,
     0,0,0,0,0,0,0,0,153,234,254,254,187,142,8,0,0,191,40,198,
     246,223,253,21,0,0,0,0,0,0,0,0,0,0,8,126,253,254,233,128,
     11,0,0,0,0,210,43,70,254,254,254,21,0,0,0,0,0,0,0,0,
     0,0,72,243,254,228,54,0,0,0,0,3,32,116,225,242,254,255,162,5,
     0,0,0,0,0,0,0,0,0,0,75,240,254,223,109,138,178,178,169,210,
     251,231,254,254,254,232,38,0,0,0,0,0,0,0,0,0,0,0,9,175,
     244,253,255,254,254,251,254,254,254,254,254,252,171,25,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,16,136,195,176,146,153,200,254,254,254,254,150,
     16,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,162,254,254,241,99,3,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,118,250,254,254,90,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,100,242,254,254,
     211,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,54,241,254,254,242,59,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,131,254,254,244,64,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,13,249,
     254,254,152,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,12,228,254,254,208,8,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,78,255,254,254,66,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,209,254,254,137,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,227,255,233,25,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,113,255,108,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0}
};

static const uint8_t test_labels[10] = {
    7,
    2,
    1,
    0,
    4,
    1,
    4,
    9,
    5,
    9
};


// --------------------------------------------------------
void pack_binary_image_to_words(
    const uint8_t img[784],          // 입력: 28x28 그레이스케일 이미지
    D_TYPE packed_words[25]          // 출력: 25개 32비트 워드
) {
    // 784개 픽셀을 25개 워드로 패킹 (784 = 25 * 32 - 16)
    for (int word_idx = 0; word_idx < 25; word_idx++) {
        D_TYPE packed_word = 0;

        for (int bit_idx = 0; bit_idx < 32; bit_idx++) {
            int pixel_idx = word_idx * 32 + bit_idx;

            if (pixel_idx < 784) {
                // 그레이스케일 값을 이진화 (임계값 128)
                uint8_t binary_pixel = (img[pixel_idx] > 128) ? 1 : 0;

                // MSB부터 패킹 (numpy.packbits와 일치하도록 수정)
                if (binary_pixel) {
                    packed_word |= (D_TYPE(1) << (31 - bit_idx));
                }
            }
        }

        packed_words[word_idx] = packed_word;
    }
}

void verify_test_data() {
    std::cout << "\n=== Test Data Verification ===\n";

    // 각 이미지의 흰색 픽셀 수 계산
    for (int img = 0; img < 10; img++) {
        int white_count = 0;
        for (int i = 0; i < 784; i++) {
            if (test_imgs[img][i] > 128) white_count++;
        }
        std::cout << "Image " << img << " (Label " << (int)test_labels[img]
                  << "): " << white_count << " white pixels\n";

        // 첫 번째 패킹된 워드 확인
        D_TYPE packed[25];
        pack_binary_image_to_words(test_imgs[img], packed);
        std::cout << "  First packed word: 0x" << std::hex << packed[0] << std::dec << "\n";
    }
}
// --------------------------------------------------------
void interpret_batch_output(
    AXI_VAL output_stream[BATCH_SIZE * FC_OUTPUT],
    const uint8_t expected_labels[BATCH_SIZE],
    int batch_start_idx
) {
    std::cout << "\n=== Batch Results ===\n";

    // 각 샘플에 대해 처리
    for (int sample = 0; sample < BATCH_SIZE; sample++) {
        int img_idx = batch_start_idx + sample;
        if (img_idx >= 10) break;  // 실제 이미지만 처리

        std::cout << "Image " << img_idx << " (Label: " << (int)expected_labels[sample] << "):\n";

        // FC 출력값 추출 및 argmax 계산
        int16_t logits[FC_OUTPUT];
        int predicted_class = 0;
        int16_t max_logit = -32768;  // INT16_MIN

        for (int j = 0; j < FC_OUTPUT; j++) {
            int stream_idx = sample * FC_OUTPUT + j;
            uint32_t raw_value = pop_stream_uint32(output_stream[stream_idx]);

            // 하위 16비트를 signed 16비트로 해석
            logits[j] = (int16_t)(raw_value & 0xFFFF);

            std::cout << "  Class " << j << ": " << logits[j];

            if (logits[j] > max_logit) {
                max_logit = logits[j];
                predicted_class = j;
            }
        }

        std::cout << "\n  Predicted: " << predicted_class;
        std::cout << " [" << (predicted_class == expected_labels[sample] ? "CORRECT" : "WRONG") << "]\n\n";
    }
}
// --------------------------------------------------------
// 배치 데이터 준비 함수 - 변경 없음
void prepare_batch_input(
    const uint8_t batch_imgs[BATCH_SIZE][784],    // 입력: 배치 이미지들
    AXI_VAL input_stream[BATCH_SIZE * 25]         // 출력: AXI 스트림 배열
) {
    for (int batch_idx = 0; batch_idx < BATCH_SIZE; batch_idx++) {
        D_TYPE packed_words[25];

        // 현재 배치 이미지를 이진화하여 패킹 (MSB부터)
        pack_binary_image_to_words(batch_imgs[batch_idx], packed_words);

        // AXI 스트림 형태로 변환
        for (int word_idx = 0; word_idx < 25; word_idx++) {
            int stream_idx = batch_idx * 25 + word_idx;
            input_stream[stream_idx] = push_stream_uint32(packed_words[word_idx], false);
        }
    }
}
int main() {
    verify_test_data();
    std::cout << "=== MNIST CNN Batch Processing Test ===\n";
    std::cout << "Batch Size: " << BATCH_SIZE << "\n";
    std::cout << "Total Images: 10\n\n";

    // BATCH_SIZE가 1이면 10번 실행, 10이면 1번 실행
    int num_runs = (BATCH_SIZE == 1) ? 10 : 1;
    int correct_predictions = 0;
    int total_predictions = 0;

    for (int run = 0; run < num_runs; run++) {
        std::cout << "Processing run " << (run + 1) << "/" << num_runs << "\n";

        // AXI 스트림 배열 준비
        AXI_VAL input_stream[BATCH_SIZE * 25];
        AXI_VAL output_stream[BATCH_SIZE * FC_OUTPUT];

        // 현재 실행을 위한 이미지와 레이블 준비
        uint8_t batch_imgs[BATCH_SIZE][784];
        uint8_t batch_labels[BATCH_SIZE];

        if (BATCH_SIZE == 1) {
            // 배치 크기가 1일 때: 한 번에 하나의 이미지만 처리
            for (int j = 0; j < 784; j++) {
                batch_imgs[0][j] = test_imgs[run][j];
            }
            batch_labels[0] = test_labels[run];
        } else {
            // 배치 크기가 10일 때: 모든 이미지를 한 번에 처리
            for (int i = 0; i < BATCH_SIZE && i < 10; i++) {
                for (int j = 0; j < 784; j++) {
                    batch_imgs[i][j] = test_imgs[i][j];
                }
                batch_labels[i] = test_labels[i];
            }
            // 만약 BATCH_SIZE > 10이면 나머지는 0으로 패딩
            for (int i = 10; i < BATCH_SIZE; i++) {
                for (int j = 0; j < 784; j++) {
                    batch_imgs[i][j] = 0;
                }
                batch_labels[i] = 0;
            }
        }

        // 배치 입력 데이터 준비
        prepare_batch_input(batch_imgs, input_stream);

        // HLS 함수 호출
        mnist_cnn_top(input_stream, output_stream);

        // 결과 해석 및 출력
        std::cout << "\n=== Results ===\n";
        int actual_batch_size = (BATCH_SIZE == 1) ? 1 : std::min(BATCH_SIZE, 10);

        for (int i = 0; i < actual_batch_size; i++) {
            int img_idx = (BATCH_SIZE == 1) ? run : i;

            std::cout << "Image " << img_idx << " (Label: " << (int)batch_labels[i] << "):\n";

            // FC 출력값 추출 및 argmax 계산
            int16_t logits[FC_OUTPUT];
            int predicted_class = 0;
            int16_t max_logit = -32768;

            for (int j = 0; j < FC_OUTPUT; j++) {
                int stream_idx = i * FC_OUTPUT + j;
                uint32_t raw_value = pop_stream_uint32(output_stream[stream_idx]);
                logits[j] = (int16_t)(raw_value & 0xFFFF);

                std::cout << "  Class " << j << ": " << logits[j];

                if (logits[j] > max_logit) {
                    max_logit = logits[j];
                    predicted_class = j;
                }
            }

            std::cout << "\n  Predicted: " << predicted_class;
            std::cout << " [" << (predicted_class == batch_labels[i] ? "CORRECT" : "WRONG") << "]\n\n";

            // 정확도 계산
            if (predicted_class == batch_labels[i]) {
                correct_predictions++;
            }
            total_predictions++;
        }
    }

    // 최종 결과 출력
    std::cout << "=== Final Results ===\n";
    std::cout << "Total Images Tested: " << total_predictions << "\n";
    std::cout << "Correct Predictions: " << correct_predictions << "\n";
    std::cout << "Accuracy: " << (float)correct_predictions / total_predictions * 100.0f << "%\n";

    return 0;
}
